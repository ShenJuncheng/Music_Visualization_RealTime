<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>test_doxygen: rpi_ws281x</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by docs! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">test_doxygen<span id="projectnumber">&#160;beta 1.0.0</span>
   </div>
   <div id="projectbrief">test_doxygen</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">rpi_ws281x </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Userspace Raspberry Pi library for controlling WS281X LEDs. This includes WS2812 and SK6812RGB RGB LEDs Preliminary support is now included for SK6812RGBW LEDs (yes, RGB + W) The LEDs can be controlled by either the PWM (2 independent channels) or PCM controller (1 channel) or the SPI interface (1 channel).</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Bindings:</h2>
<p>Language-specific bindings for rpi_ws281x are available in:</p>
<ul>
<li>Python - <a href="https://github.com/rpi-ws281x/rpi-ws281x-python">https://github.com/rpi-ws281x/rpi-ws281x-python</a></li>
<li>Rust - <a href="https://github.com/rpi-ws281x/rpi-ws281x-rust">https://github.com/rpi-ws281x/rpi-ws281x-rust</a></li>
<li>Powershell - <a href="https://github.com/rpi-ws281x/rpi-ws281x-powershell">https://github.com/rpi-ws281x/rpi-ws281x-powershell</a></li>
<li>Java - <a href="https://github.com/rpi-ws281x/rpi-ws281x-java">https://github.com/rpi-ws281x/rpi-ws281x-java</a></li>
<li>CSharp - <a href="https://github.com/rpi-ws281x/rpi-ws281x-csharp">https://github.com/rpi-ws281x/rpi-ws281x-csharp</a></li>
<li>Go - <a href="https://github.com/rpi-ws281x/rpi-ws281x-go">https://github.com/rpi-ws281x/rpi-ws281x-go</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Background:</h2>
<p>The BCM2835 in the Raspberry Pi has both a PWM and a PCM module that are well suited to driving individually controllable WS281X LEDs. Using the DMA, PWM or PCM FIFO, and serial mode in the PWM, it's possible to control almost any number of WS281X LEDs in a chain connected to the appropriate output pin. For SPI the Raspbian spidev driver is used (<code>/dev/spidev0.0</code>). This library and test program set the clock rate to 3X the desired output frequency and creates a bit pattern in RAM from an array of colors where each bit is represented by 3 bits as follows. </p><pre class="fragment">Bit 1 - 1 1 0
Bit 0 - 1 0 0
</pre><h2><a class="anchor" id="autotoc_md14"></a>
GPIO Usage:</h2>
<p>The GPIOs that can be used are limited by the hardware of the Pi and will vary based on the method used to drive them (PWM, PCM or SPI). Beware that the GPIO numbers are not the same as the physical pin numbers on the header.</p>
<p>PWM: </p><div class="fragment"><div class="line">PWM0, which can be set to use GPIOs 12, 18, 40, and 52.</div>
<div class="line">Only 12 (pin 32) and 18 (pin 12) are available on the B+/2B/3B</div>
<div class="line"> </div>
<div class="line">PWM1 which can be set to use GPIOs 13, 19, 41, 45 and 53.</div>
<div class="line">Only 13 is available on the B+/2B/PiZero/3B, on pin 33</div>
</div><!-- fragment --><p>PCM: </p><div class="fragment"><div class="line">PCM_DOUT, which can be set to use GPIOs 21 and 31.</div>
<div class="line">Only 21 is available on the B+/2B/PiZero/3B, on pin 40.</div>
</div><!-- fragment --><p>SPI: </p><div class="fragment"><div class="line">SPI0-MOSI is available on GPIOs 10 and 38.</div>
<div class="line">Only GPIO 10 is available on all models.</div>
<div class="line">See also note for RPi 3 below.</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
Power and voltage requirements</h2>
<p>WS281X LEDs are generally driven at 5V. Depending on your actual LED model and data line length you might be able to successfully drive the data input with 3.3V. However in the general case you probably want to use a level shifter to convert from the Raspberry Pi GPIO/PWM to 5V.</p>
<p>It is also possible to run the LEDs from a 3.3V - 3.6V power source, and connect the GPIO directly at a cost of brightness, but this isn't recommended.</p>
<p>The test program is designed to drive a 8x8 grid of LEDs e.g.from Adafruit (<a href="http://www.adafruit.com/products/1487">http://www.adafruit.com/products/1487</a>) or Pimoroni (<a href="https://shop.pimoroni.com/products/unicorn-hat">https://shop.pimoroni.com/products/unicorn-hat</a>). Please see the Adafruit and Pimoroni websites for more information.</p>
<p>Know what you're doing with the hardware and electricity. I take no reponsibility for damage, harm, or mistakes.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Build:</h2>
<h3><a class="anchor" id="autotoc_md17"></a>
Build with SCons:</h3>
<ul>
<li>Install Scons (on raspbian, <code>apt-get install scons</code>).</li>
<li>Make sure to adjust the parameters in main.c to suit your hardware.<ul>
<li>Signal rate (400kHz to 800kHz). Default 800kHz.</li>
<li>ledstring.invert=1 if using a inverting level shifter.</li>
<li>Width and height of LED matrix (height=1 for LED string).</li>
</ul>
</li>
<li>Type <code>scons</code> from inside the source directory.</li>
</ul>
<h3><a class="anchor" id="autotoc_md18"></a>
Build and install with CMake:</h3>
<ul>
<li>Install CMake</li>
<li><p class="startli">Configure your build:</p>
<p class="startli">For example: </p><div class="fragment"><div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake -D BUILD_SHARED=OFF -D BUILD_TEST=ON ..</div>
</div><!-- fragment --><p> See also for available options in <code>CMakeLists.txt</code>.</p>
</li>
<li>Type <code>cmake --build .</code> to build</li>
<li>To install built binaries and headers into your system type: <div class="fragment"><div class="line">sudo make install</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md19"></a>
Running:</h2>
<ul>
<li>Type <code>sudo ./test</code> (default uses PWM channel 0).</li>
<li>That's it. You should see a moving rainbow scroll across the display.</li>
<li>More options are available, <code>./test -h</code> should show them: <div class="fragment"><div class="line">./test version 1.1.0</div>
<div class="line">Usage: ./test</div>
<div class="line">-h (--help)    - this information</div>
<div class="line">-s (--strip)   - strip type - rgb, grb, gbr, rgbw</div>
<div class="line">-x (--width)   - matrix width (default 8)</div>
<div class="line">-y (--height)  - matrix height (default 8)</div>
<div class="line">-d (--dma)     - dma channel to use (default 10)</div>
<div class="line">-g (--gpio)    - GPIO to use</div>
<div class="line">                 If omitted, default is 18 (PWM0)</div>
<div class="line">-i (--invert)  - invert pin output (pulse LOW)</div>
<div class="line">-c (--clear)   - clear matrix on exit.</div>
<div class="line">-v (--version) - version information</div>
</div><!-- fragment --></li>
</ul>
<h2><a class="anchor" id="autotoc_md20"></a>
Important warning about DMA channels</h2>
<p>You must make sure that the DMA channel you choose to use for the LEDs is not <a href="https://www.raspberrypi.org/forums/viewtopic.php?p=609380#p609380">already in use</a> by the operating system.</p>
<p>For example, <b>using DMA channel 5 <a href="https://github.com/jgarff/rpi_ws281x/issues/224">will cause</a> filesystem corruption</b> on the Raspberry Pi 3 Model B.</p>
<p>The default DMA channel (10) should be safe for the Raspberry Pi 3 Model B, but this may change in future software releases.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
Limitations:</h2>
<h3><a class="anchor" id="autotoc_md22"></a>
PWM</h3>
<p>Since this library and the onboard Raspberry Pi audio both use the PWM, they cannot be used together. You will need to blacklist the Broadcom audio kernel module by creating a file <code>/etc/modprobe.d/snd-blacklist.conf</code> with </p><pre class="fragment">blacklist snd_bcm2835
</pre><p> If the audio device is still loading after blacklisting, you may also need to comment it out in the /etc/modules file.</p>
<p>On headless systems you may also need to force audio through hdmi Edit config.txt and add: </p><pre class="fragment">hdmi_force_hotplug=1
hdmi_force_edid_audio=1
</pre><p> A reboot is required for this change to take effect</p>
<p>Some distributions use audio by default, even if nothing is being played. If audio is needed, you can use a USB audio device instead.</p>
<h3><a class="anchor" id="autotoc_md23"></a>
PCM</h3>
<p>When using PCM you cannot use digital audio devices which use I2S since I2S uses the PCM hardware, but you can use analog audio.</p>
<h3><a class="anchor" id="autotoc_md24"></a>
SPI</h3>
<p>When using SPI the led string is the only device which can be connected to the SPI bus. Both digital (I2S/PCM) and analog (PWM) audio can be used.</p>
<p>Many distributions have a maximum SPI transfer of 4096 bytes. This can be changed in <code>/boot/cmdline.txt</code> by appending </p><div class="fragment"><div class="line">spidev.bufsiz=32768</div>
</div><!-- fragment --><p>On an RPi 3 you have to change the GPU core frequency to 250 MHz, otherwise the SPI clock has the wrong frequency.</p>
<p>Do this by adding the following line to /boot/config.txt and reboot:</p>
<div class="fragment"><div class="line">core_freq=250</div>
</div><!-- fragment --><p>On an RPi 4 you must set a fixed frequency to avoid the idle CPU scaling changing the SPI frequency and breaking the ws281x timings:</p>
<p>Do this by adding the following lines to /boot/config.txt and reboot:</p>
<div class="fragment"><div class="line">core_freq=500</div>
<div class="line">core_freq_min=500</div>
</div><!-- fragment --><p>SPI requires you to be in the <code>gpio</code> group if you wish to control your LEDs without root.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Comparison PWM/PCM/SPI</h2>
<p>Both PWM and PCM use DMA transfer to output the control signal for the LEDs. The max size of a DMA transfer is 65536 bytes. Since each LED needs 12 bytes (4 colors, 8 symbols per color, 3 bits per symbol) this means you can control approximately 5400 LEDs for a single strand in PCM and 2700 LEDs per string for PWM (Only PWM can control 2 independent strings simultaneously) SPI uses the SPI device driver in the kernel. For transfers larger than 96 bytes the kernel driver also uses DMA. Of course there are practical limits on power and signal quality. These will be more constraining in practice than the theoretical limits above.</p>
<p>When controlling a LED string of 240 LEDs the CPU load on the original Pi 2 (BCM2836) are: PWM 5% PCM 5% SPI 1%</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Usage:</h2>
<p>The API is very simple. Make sure to create and initialize the <code><a class="el" href="structws2811__t.html">ws2811_t</a></code> structure as seen in <a href="main.c"><code>main.c</code></a>. From there it can be initialized by calling <code>ws2811_init()</code>. LEDs are changed by modifying the color in the <code>.led[index]</code> array and calling <code>ws2811_render()</code>. The rest is handled by the library, which either creates the DMA memory and starts the DMA for PWM and PCM or prepares the SPI transfer buffer and sends it out on the MISO pin.</p>
<p>Make sure to hook a signal handler for SIGKILL to do cleanup. From the handler make sure to call <code>ws2811_fini()</code>. It'll make sure that the DMA is finished before program execution stops and cleans up after itself. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
